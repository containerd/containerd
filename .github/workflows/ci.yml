name: CI
on:
  # When added to a merge queue.
  # See https://docs.github.com/en/repositories/configuring-branches-and-merges-in-your-repository/configuring-pull-request-merges/managing-a-merge-queue#triggering-merge-group-checks-with-github-actions
  merge_group:
  push:
    branches:
      - main
      - "release/**"
  pull_request:
    branches:
      - main
      - "release/**"

env:
  # Go version we currently use to build containerd across all CI.
  # Note: don't forget to update `Binaries` step, as it contains the matrix of all supported Go versions.
  GO_VERSION: "1.20.4"

permissions: # added using https://github.com/step-security/secure-workflows
  contents: read

jobs:
  integration-linux:
    name: Linux Integration
    runs-on: ubuntu-20.04
    timeout-minutes: 40

    steps:
      - uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: false # see actions/setup-go#368

      - uses: actions/checkout@v3

      - name: Install containerd dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y gperf

      - name: Tests
        run: |
          go test -c -o /tmp/blockfile.test ./snapshots/blockfile
          set +e
          sudo /tmp/blockfile.test -test.v -test.root -test.count=100 -test.failfast  -test.timeout=60m
          exitcode=$?
          set -e
          sudo dmesg
          exit $exitcode
